<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>LinQ VAL Scanner</title>
  <style>
    :root{
      --ink:#141316; --muted:rgba(20,19,22,.62); --line:rgba(20,19,22,.10);
      --accent:#e11d48; --shadow: 0 10px 28px rgba(20,19,22,.10);
      --r:18px; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--ink);
      background:
        radial-gradient(900px 480px at 15% -10%, rgba(225,29,72,.10), transparent 60%),
        radial-gradient(700px 420px at 100% 0%, rgba(225,29,72,.08), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, #fff6f8 100%);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 26px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;border:1px solid var(--line);border-radius: var(--r);
      background: rgba(255,255,255,.90);box-shadow: var(--shadow);backdrop-filter: blur(6px);
    }
    .title h1{margin:0;font-size:18px;font-weight:1200;letter-spacing:.2px;line-height:1.1}
    .title .sub{margin-top:3px;font-size:13px;color:var(--muted);line-height:1.2}
    .build{font-size:12px;color:var(--muted);padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;white-space:nowrap}
    .build b{color:var(--ink)}
    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:12px;margin-top:12px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{border:1px solid var(--line);border-radius: var(--r);background: rgba(255,255,255,.92);box-shadow: var(--shadow);overflow:hidden}
    .hd{
      padding:12px 14px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background: linear-gradient(90deg, rgba(225,29,72,.08), rgba(255,255,255,0));
    }
    .hd .label{font-size:14px;font-weight:1200;letter-spacing:.2px}
    .bd{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);
      padding:14px 14px;border-radius: 14px;cursor:pointer;
      font-size:16px;font-weight:1200;letter-spacing:.2px;user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: rgba(225,29,72,.28);
      box-shadow: 0 10px 18px rgba(225,29,72,.10);
      background: linear-gradient(135deg, rgba(225,29,72,.12), rgba(255,255,255,.0));
    }
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px;color:var(--muted);background:#fff;white-space:nowrap}
    .dot{width:10px;height:10px;border-radius:999px;background: rgba(20,19,22,.20)}
    .pill.on .dot{ background: var(--accent); }

    .videoWrap{position:relative;border-radius: var(--r);overflow:hidden;border:1px solid var(--line);background:#000}
    video{width:100%;height:auto;display:block}
    .overlay{pointer-events:none;position:absolute; inset:0;background: linear-gradient(180deg, rgba(0,0,0,.10), transparent 25%, transparent 75%, rgba(0,0,0,.18));}

    /* popout */
    .popout{
      position:absolute;left:12px; right:12px; bottom:12px;
      border-radius: 18px; border:1px solid rgba(225,29,72,.25);
      background: linear-gradient(135deg, rgba(225,29,72,.22), rgba(255,255,255,.90) 60%);
      box-shadow: 0 18px 40px rgba(20,19,22,.22);
      backdrop-filter: blur(6px);
      padding:14px 14px; display:none;
    }
    .popout.show{display:block; animation: pop .16s ease-out}
    @keyframes pop{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform: translateY(0)}}
    .popTop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .popStatus{font-size:34px;font-weight:1400;letter-spacing:.2px;line-height:1;color: var(--accent)}
    .popMeta{font-size:13px;color:rgba(20,19,22,.65);line-height:1.2;text-align:right;white-space:nowrap}
    .bigA{margin-top:8px;font-size:22px;font-weight:1400;line-height:1.18}
    .bigB{margin-top:6px;font-size:24px;font-weight:1400;color: var(--accent);letter-spacing:.2px;line-height:1.1}
    .bigC{margin-top:6px;font-size:20px;font-weight:1350;line-height:1.18}
    .bigD{margin-top:6px;font-size:20px;font-weight:1350;line-height:1.18}
    .popSmall{margin-top:8px;font-size:13px;color:rgba(20,19,22,.65);font-family: var(--mono);word-break: break-all}

    .hint{margin-top:10px;font-size:14px;color:var(--muted);line-height:1.35}
    .mono{font-family:var(--mono)}
    .em{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid rgba(225,29,72,.22);background: rgba(225,29,72,.08);font-weight:1200}

    .okBanner{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 14px;border:1px solid var(--line);border-radius: 16px;
      background: linear-gradient(135deg, rgba(225,29,72,.10), rgba(255,255,255,0) 60%);
    }
    .okLeft{display:flex;align-items:center;gap:12px}
    .badgeDot{width:14px;height:14px;border-radius:999px;background: rgba(20,19,22,.20)}
    .okText{font-size:34px;font-weight:1400;letter-spacing:.2px;line-height:1}
    .okSub{font-size:14px;color:var(--muted);margin-top:2px}
    .rightInfo{font-size:14px;color:var(--muted)}

    .R_name{margin-top:14px;font-size:26px;font-weight:1400;line-height:1.18;letter-spacing:.1px}
    .R_price{margin-top:10px;font-size:26px;font-weight:1400;color: var(--accent);letter-spacing:.2px;line-height:1.1}
    .R_no{margin-top:10px;font-size:22px;font-weight:1350;line-height:1.15}
    .R_sta{margin-top:8px;font-size:22px;font-weight:1350;line-height:1.15}
    .R_maker{margin-top:8px;font-size:16px;color:var(--muted);line-height:1.25}

    .miniRow{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--line);border-radius:999px;
      background:#fff;color:var(--muted);font-size:13px;
    }
    .chip b{color:var(--ink);font-weight:1300}

    details{margin-top:10px}
    summary{cursor:pointer;color:var(--muted);font-weight:1100}
    .log{margin-top:8px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:#fff;color:#666;
      white-space:pre-wrap;font-family:var(--mono);font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>LinQ VAL Scanner</h1>
        <div class="sub">ROI拡大 + 90度回転対応（iPhone Safari向けデコード強化）</div>
      </div>
      <div class="build">BUILD <b id="buildLabel">v0</b></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <div class="label">スキャン</div>
          <div class="row">
            <div class="pill" id="pillZxing"><span class="dot"></span><span>ZXing</span></div>
            <div class="pill" id="pillCam"><span class="dot"></span><span>Camera</span></div>
            <div class="pill" id="pillDict"><span class="dot"></span><span>Dict</span></div>
          </div>
        </div>

        <div class="bd">
          <div class="row">
            <button class="btn primary" id="btnStart">Start</button>
            <button class="btn" id="btnStop">Stop</button>
          </div>

          <div style="margin-top:12px" class="videoWrap">
            <video id="video" playsinline muted></video>
            <div class="overlay"></div>

            <div class="popout" id="popout">
              <div class="popTop">
                <div class="popStatus" id="popStatus">OK</div>
                <div class="popMeta" id="popMeta">—</div>
              </div>
              <div class="bigA" id="popName">—</div>
              <div class="bigB" id="popTotal">—</div>
              <div class="bigC" id="popProdNo">—</div>
              <div class="bigD" id="popProdSta">—</div>
              <div class="popSmall" id="popSmall">—</div>
            </div>
          </div>

          <div class="hint">
            JAN-13優先：バーコードを画面中央に大きく写して静止。<span class="em">同一バーコードは5秒間無視</span>
          </div>

          <details>
            <summary>ログ</summary>
            <div class="log" id="log">Ready.</div>
          </details>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="label">結果</div>
          <div class="row">
            <button class="btn" id="btnNext">候補切替</button>
            <button class="btn" id="btnClear">Clear</button>
          </div>
        </div>

        <div class="bd">
          <div class="okBanner">
            <div class="okLeft">
              <div class="badgeDot" id="dotStatus"></div>
              <div>
                <div class="okText" id="txtStatus">待機</div>
                <div class="okSub" id="txtSub">Startで起動</div>
              </div>
            </div>
            <div class="rightInfo">ログ <span class="mono" id="logCount">0</span> 件</div>
          </div>

          <div class="R_name" id="vName">—</div>
          <div class="R_price" id="vTotalPrice">—</div>
          <div class="R_no" id="vProdNo">—</div>
          <div class="R_sta" id="vProdSta">—</div>
          <div class="R_maker" id="vMaker">—</div>

          <div class="miniRow">
            <div class="chip">候補 <b id="candPos">0</b> / <b id="candTotal">0</b></div>
            <div class="chip">JAN <b class="mono" id="vJan">—</b></div>
            <div class="chip">GTIN <b class="mono" id="vGtin">—</b></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const BUILD = "v2026-01-20-09";
  document.getElementById("buildLabel").textContent = BUILD;

  const $ = (id)=>document.getElementById(id);
  const el = {
    pillZxing: $("pillZxing"), pillCam: $("pillCam"), pillDict: $("pillDict"),
    video: $("video"), log: $("log"),

    popout: $("popout"), popStatus: $("popStatus"), popMeta: $("popMeta"),
    popName: $("popName"), popTotal: $("popTotal"),
    popProdNo: $("popProdNo"), popProdSta: $("popProdSta"), popSmall: $("popSmall"),

    dotStatus: $("dotStatus"), txtStatus: $("txtStatus"), txtSub: $("txtSub"), logCount: $("logCount"),

    vName: $("vName"), vTotalPrice: $("vTotalPrice"), vProdNo: $("vProdNo"),
    vProdSta: $("vProdSta"), vMaker: $("vMaker"),
    vJan: $("vJan"), vGtin: $("vGtin"), candPos: $("candPos"), candTotal: $("candTotal"),

    btnStart: $("btnStart"), btnStop: $("btnStop"), btnNext: $("btnNext"), btnClear: $("btnClear")
  };

  function log(msg){ el.log.textContent = msg + "\n\n" + el.log.textContent; }
  function setPill(p,on){ p.classList.toggle("on", !!on); }
  function digits(s){ return (s ?? "").toString().replace(/\D/g,""); }
  function fmtYenInt(s){
    const d = digits(s); if (!d) return "";
    const n = Number(d); return Number.isFinite(n) ? ("¥"+n.toLocaleString("ja-JP")) : ("¥"+d);
  }
  function setStatus(kind, label, sub){
    el.dotStatus.style.background =
      kind==="ok" ? "var(--accent)" :
      kind==="warn" ? "rgba(225,29,72,.45)" :
      "rgba(20,19,22,.20)";
    el.txtStatus.textContent = label;
    el.txtSub.textContent = sub || "";
  }
  function showPopout({status, meta, name, totalYen, prodNo, prodSta, small}){
    el.popStatus.textContent = status;
    el.popMeta.textContent = meta || "";
    el.popName.textContent = name || "—";
    el.popTotal.textContent = totalYen || "—";
    el.popProdNo.textContent = prodNo ? ("製品番号: " + prodNo) : "—";
    el.popProdSta.textContent = prodSta ? ("規格: " + prodSta) : "—";
    el.popSmall.textContent = small || "";
    el.popout.classList.add("show");
    clearTimeout(showPopout._t);
    showPopout._t = setTimeout(()=>el.popout.classList.remove("show"), 2200);
  }

  // ===== camera =====
  let stream = null;
  async function startCamera(){
    const constraints = { audio:false, video:{ facingMode:{ ideal:"environment" } } };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    el.video.srcObject = stream;
    await el.video.play();
    setPill(el.pillCam, true);
    const track = stream.getVideoTracks()[0];
    const s = track.getSettings ? track.getSettings() : {};
    log("Camera OK. settings=" + JSON.stringify(s));
  }
  async function stopCamera(){
    try{ el.video.pause(); el.video.srcObject=null; }catch(e){}
    try{ if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(e){}
    setPill(el.pillCam, false);
  }

  // ===== ZXing loader =====
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement("script");
      s.src = src; s.async = true;
      s.onload = resolve; s.onerror = ()=>reject(new Error("Failed "+src));
      document.head.appendChild(s);
    });
  }
  async function ensureZXing(){
    if (window.ZXing?.MultiFormatReader) return true;
    const bust = "v=" + encodeURIComponent(BUILD) + "&t=" + Date.now();
    const urls = [
      "https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js?" + bust,
      "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js?" + bust
    ];
    for (const u of urls){
      try{
        await loadScript(u);
        if (window.ZXing?.MultiFormatReader) return true;
      }catch(e){}
    }
    return false;
  }

  // ===== Dict split loading =====
  const cache = new Map();
  async function fetchText(url){
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("HTTP "+res.status);
    return await res.text();
  }
  function parseCSV(text){
    const rows=[]; let i=0, field="", row=[], inQ=false;
    while (i<text.length){
      const c=text[i];
      if (inQ){
        if (c === '"'){
          if (text[i+1] === '"'){ field+='"'; i+=2; continue; }
          inQ=false; i++; continue;
        }
        field+=c; i++; continue;
      }else{
        if (c === '"'){ inQ=true; i++; continue; }
        if (c === ","){ row.push(field); field=""; i++; continue; }
        if (c === "\n"){
          row.push(field); field="";
          if (row.length>1 || (row.length===1 && row[0]!== "")) rows.push(row);
          row=[]; i++; continue;
        }
        if (c === "\r"){ i++; continue; }
        field+=c; i++; continue;
      }
    }
    row.push(field);
    if (row.length>1 || (row.length===1 && row[0]!== "")) rows.push(row);
    return rows;
  }
  function toObjects(rows){
    if (!rows.length) return [];
    const header=rows[0].map(h=>(h??"").trim());
    const objs=[];
    for (let r=1;r<rows.length;r++){
      const arr=rows[r]; const o={};
      for (let c=0;c<header.length;c++) o[header[c]]=(arr[c]??"").trim();
      objs.push(o);
    }
    return objs;
  }
  async function loadObjects(url){
    if (cache.has(url)) return cache.get(url);
    const t=await fetchText(url);
    const objs=toObjects(parseCSV(t));
    cache.set(url, objs);
    return objs;
  }
  function pick3_4(d){
    d = digits(d);
    if (d.length<4) return ["",""];
    return [d.slice(0,3), d.slice(0,4)];
  }
  async function lookupCandidatesByJan(jan13){
    const [jan3, jan4]=pick3_4(jan13);
    if (!jan4) return [];
    const rows=await loadObjects(`dict_jan/${jan3}/${jan4}.csv`);
    return rows.filter(r=>digits(r.jan13keta)===jan13);
  }
  async function lookupJanByGtin(gtin14){
    const [gt3, gt4]=pick3_4(gtin14);
    if (!gt4) return "";
    const rows=await loadObjects(`gtin_index/${gt3}/${gt4}.csv`);
    const hit=rows.find(r=>digits(r.gtin14)===gtin14);
    return hit ? digits(hit.jan13keta) : "";
  }
  function gtinMatchesCandidate(gtin14, cand){
    const gt=digits(gtin14);
    if (!gt) return false;
    return gt===digits(cand.gtin14_i0)||gt===digits(cand.gtin14_i1)||gt===digits(cand.gtin14_i2);
  }
  function pickBestCandidate(cands, gtin14){
    if (!cands.length) return {best:null, ordered:[]};
    let pool=cands;
    if (gtin14){
      const m=cands.filter(c=>gtinMatchesCandidate(gtin14,c));
      if (m.length) pool=m;
    }
    const ordered=pool
      .map((c,idx)=>({c,idx,price:Number(digits(c.total_reimbursement_price_yen||""))||0}))
      .sort((a,b)=>b.price-a.price||a.idx-b.idx)
      .map(x=>x.c);
    return {best:ordered[0], ordered};
  }

  // ===== candidate UI =====
  let currentCandidates=[], currentIndex=0, currentJan="", currentGtin="";
  function renderCandidate(idx){
    const total=currentCandidates.length;
    el.candTotal.textContent=String(total);
    if (!total){
      el.candPos.textContent="0";
      el.vName.textContent="—"; el.vTotalPrice.textContent="—";
      el.vProdNo.textContent="—"; el.vProdSta.textContent="—";
      el.vMaker.textContent="—";
      el.vJan.textContent=currentJan||"—"; el.vGtin.textContent=currentGtin||"—";
      return;
    }
    currentIndex=(idx+total)%total;
    el.candPos.textContent=String(currentIndex+1);
    const c=currentCandidates[currentIndex];

    el.vName.textContent=c.product_name||"—";
    el.vTotalPrice.textContent=fmtYenInt(c.total_reimbursement_price_yen||"")||"—";
    el.vProdNo.textContent=c.product_no?("製品番号: "+c.product_no):"—";
    el.vProdSta.textContent=c.product_sta?("規格: "+c.product_sta):"—";
    el.vMaker.textContent=c.manufacturer_name||"—";

    el.vJan.textContent=currentJan||digits(c.jan13keta)||"—";
    el.vGtin.textContent=currentGtin||digits(c.gtin14_i0)||digits(c.gtin14_i1)||digits(c.gtin14_i2)||"—";
  }
  el.btnNext.addEventListener("click", ()=>{ if (currentCandidates.length) renderCandidate(currentIndex+1); });

  // ===== ZXing core decode from ImageData =====
  let mf = null;
  let scanTimer = null;
  let busy = false;

  const DEDUP_MS=5000;
  let lastRaw="", lastAt=0;

  // canvases
  const base = document.createElement("canvas");
  const bctx = base.getContext("2d", {alpha:false, willReadFrequently:true});
  const roi = document.createElement("canvas");
  const rctx = roi.getContext("2d", {alpha:false, willReadFrequently:true});
  const rot = document.createElement("canvas");
  const xctx = rot.getContext("2d", {alpha:false, willReadFrequently:true});

  function buildDecoder(){
    const ZX = window.ZXing;
    const hints = new Map();
    hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS, [
      ZX.BarcodeFormat.EAN_13,
      ZX.BarcodeFormat.EAN_8,
      ZX.BarcodeFormat.UPC_A,
      ZX.BarcodeFormat.UPC_E,
      ZX.BarcodeFormat.CODE_128
    ]);
    hints.set(ZX.DecodeHintType.TRY_HARDER, true);

    const r = new ZX.MultiFormatReader();
    r.setHints(hints);
    return r;
  }

  function decodeImageData(img){
    const ZX = window.ZXing;
    const lum = new ZX.RGBLuminanceSource(img.data, img.width, img.height);
    const bin = new ZX.BinaryBitmap(new ZX.HybridBinarizer(lum));
    return mf.decode(bin);
  }

  function rotate90(srcCanvas){
    rot.width = srcCanvas.height;
    rot.height = srcCanvas.width;
    xctx.save();
    xctx.clearRect(0,0,rot.width,rot.height);
    xctx.translate(rot.width/2, rot.height/2);
    xctx.rotate(Math.PI/2);
    xctx.drawImage(srcCanvas, -srcCanvas.width/2, -srcCanvas.height/2);
    xctx.restore();
    return rot;
  }

  function parseGS1(raw){
    let s=(raw??"").trim();
    if (s.startsWith("]C1")) s=s.slice(3);
    const GS=String.fromCharCode(29);
    let i=0;
    while (i<s.length){
      if (s[i]===GS){ i++; continue; }
      const ai2=s.slice(i,i+2);
      if (ai2==="01"){
        const val=s.slice(i+2,i+16);
        if (/^\d{14}$/.test(val)) return val;
        break;
      }
      i++;
    }
    return "";
  }

  async function onDecoded(raw){
    const t=Date.now();
    if (raw===lastRaw && (t-lastAt)<DEDUP_MS) return;
    lastRaw=raw; lastAt=t;

    // READ feedback
    showPopout({status:"READ", meta:"読み取り成功", name:(raw||"").slice(0,60), totalYen:"—", prodNo:"", prodSta:"", small:""});

    let jan13=""; let gtin14="";
    const d=digits(raw||"");
    if (d.length===13) jan13=d;
    if (!jan13 && raw.includes("01")) gtin14=digits(parseGS1(raw));
    if (!jan13 && gtin14){
      try{
        const j=await lookupJanByGtin(gtin14);
        if (j && j.length===13) jan13=j;
      }catch(e){}
    }

    currentJan=jan13||""; currentGtin=gtin14||"";
    if (!jan13 && !gtin14){
      setStatus("warn","未検出","距離/ブレ/照明");
      return;
    }

    setStatus("warn","照合中…","辞書照合");
    let cands=[];
    try{
      if (jan13) cands=await lookupCandidatesByJan(jan13);
      setPill(el.pillDict, true);
    }catch(e){
      setPill(el.pillDict, false);
      cands=[];
    }

    const {best, ordered}=pickBestCandidate(cands, gtin14);
    currentCandidates=ordered;
    renderCandidate(0);

    if (best){
      setStatus("ok","OK","辞書一致");
      const totalYen=fmtYenInt(best.total_reimbursement_price_yen||"")||"—";
      showPopout({
        status:"OK",
        meta: ordered.length>1 ? `候補${ordered.length}件` : "辞書一致",
        name: best.product_name || "—",
        totalYen,
        prodNo: best.product_no || "",
        prodSta: best.product_sta || "",
        small: `JAN:${jan13}${gtin14 ? "  GTIN:"+gtin14 : ""}`
      });
    }else{
      setStatus("warn","WARN","辞書なし");
      showPopout({
        status:"WARN",
        meta:"辞書なし",
        name: jan13 || gtin14,
        totalYen:"—",
        prodNo:"",
        prodSta:"",
        small: `JAN:${jan13}${gtin14 ? "  GTIN:"+gtin14 : ""}`
      });
    }

    const scans = loadScans();
    scans.push({ts:new Date().toISOString(), raw});
    saveScans(scans); updateCount();
  }

  async function scanOnce(){
    if (!mf || busy) return;
    if (!el.video.videoWidth || !el.video.videoHeight) return;

    busy = true;
    try{
      const vw = el.video.videoWidth;
      const vh = el.video.videoHeight;

      // base frame (smallish)
      const maxW = 640;
      const scale = Math.min(1, maxW / vw);
      const bw = Math.max(1, Math.floor(vw * scale));
      const bh = Math.max(1, Math.floor(vh * scale));
      base.width = bw; base.height = bh;
      bctx.drawImage(el.video, 0, 0, bw, bh);

      // ROI zoom (center 70% -> 720px square-ish)
      const cx = bw * 0.15;
      const cy = bh * 0.15;
      const cw = bw * 0.70;
      const ch = bh * 0.70;
      const target = 720;
      roi.width = target;
      roi.height = Math.floor(target * (ch / cw));
      rctx.drawImage(base, cx, cy, cw, ch, 0, 0, roi.width, roi.height);

      // Try decode ROI (0°)
      let img = rctx.getImageData(0,0,roi.width,roi.height);
      try{
        const res = decodeImageData(img);
        if (res){ await onDecoded(res.getText()); return; }
      }catch(e){ /* ignore */ }

      // Try decode ROI (90°)
      const rotCanvas = rotate90(roi);
      const rx = rotCanvas.getContext("2d", {alpha:false, willReadFrequently:true});
      img = rx.getImageData(0,0,rotCanvas.width, rotCanvas.height);
      try{
        const res = decodeImageData(img);
        if (res){ await onDecoded(res.getText()); return; }
      }catch(e){ /* ignore */ }

      // Try full frame (0°)
      const bimg = bctx.getImageData(0,0,base.width, base.height);
      try{
        const res = decodeImageData(bimg);
        if (res){ await onDecoded(res.getText()); return; }
      }catch(e){ /* ignore */ }

    } finally {
      // reset reader internal state each time (some iOS cases improve)
      try{ mf.reset(); }catch(e){}
      busy = false;
    }
  }

  function startLoop(){
    if (scanTimer) clearInterval(scanTimer);
    scanTimer = setInterval(scanOnce, 240);
    log("ROI/rotate decode loop started.");
  }
  function stopLoop(){
    if (scanTimer){ clearInterval(scanTimer); scanTimer=null; }
    mf = null;
    busy = false;
  }

  // ===== tiny scan count =====
  const LS_KEY = "linq_val_scan_count_v2";
  function loadScans(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch(e){ return []; } }
  function saveScans(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
  function updateCount(){ el.logCount.textContent = String(loadScans().length); }

  el.btnClear.addEventListener("click", ()=>{
    if (!confirm("ログを削除しますか？")) return;
    localStorage.removeItem(LS_KEY);
    updateCount();
    log("Logs cleared.");
  });

  async function stopAll(){
    stopLoop();
    await stopCamera();
    setStatus("idle","停止中","Startで起動");
  }

  el.btnStart.addEventListener("click", async ()=>{
    setStatus("idle","起動中…","準備中");
    await stopAll();

    const ok = await ensureZXing();
    setPill(el.pillZxing, ok);
    if (!ok){
      setStatus("warn","ZXing失敗","通信/CDN");
      return;
    }

    try{
      await startCamera();
      mf = buildDecoder();
      startLoop();
      setStatus("idle","待機","スキャンしてください");
    }catch(e){
      setStatus("warn","起動失敗", e?.name ? (e.name+": "+e.message) : "カメラ/再生失敗");
      log("Start FAILED: " + (e?.name ? (e.name+": "+e.message) : String(e)));
    }
  });

  el.btnStop.addEventListener("click", async ()=>{ await stopAll(); });

  // init
  (function init(){
    updateCount();
    setStatus("idle","待機","Startで起動");
    setPill(el.pillZxing, false);
    setPill(el.pillCam, false);
    setPill(el.pillDict, false);
    renderCandidate(0);
  })();
</script>
</body>
</html>