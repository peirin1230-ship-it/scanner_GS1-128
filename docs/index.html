<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>LinQ VAL PoC Scanner</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2d;
      --line:rgba(255,255,255,.08);
      --text:#e9eef7;
      --muted:#a7b0c0;
      --accent:#63b3ff;
      --accent2:#7c5cff;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --r1:16px;
      --r2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1100px 520px at 20% -10%, rgba(99,179,255,.18), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(124,92,255,.18), transparent 55%),
        linear-gradient(180deg, #081022 0%, #070e1a 60%, #060b14 100%);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 34px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      margin:6px 0 14px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(99,179,255,.95), rgba(124,92,255,.95));
      box-shadow: 0 10px 24px rgba(99,179,255,.12), 0 10px 24px rgba(124,92,255,.12);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:-30% -30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%);
      transform: rotate(25deg);
    }
    h1{font-size:16px;margin:0 0 2px;font-weight:800;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--line); border-radius:999px;
      background: rgba(255,255,255,.04);
      font-size:12px; color:var(--muted);
      backdrop-filter: blur(10px);
    }
    .pill b{color:var(--text);font-weight:800}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .hd h2{margin:0;font-size:13px;font-weight:900;letter-spacing:.2px}
    .bd{padding:14px}
    .hint{font-size:12px;color:var(--muted);line-height:1.45}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      appearance:none;border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;font-weight:800;font-size:13px;
      display:inline-flex;align-items:center;gap:10px;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn:active{transform: scale(.99)}
    .btn.primary{
      border-color: rgba(99,179,255,.25);
      background: linear-gradient(135deg, rgba(99,179,255,.18), rgba(124,92,255,.12));
    }
    .btn.ok{border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10)}
    .btn.danger{border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10)}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
    .select{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      font-size:13px; min-width: 220px; outline:none;
    }
    .select:focus{border-color: rgba(99,179,255,.35)}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--muted); white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background: rgba(167,176,192,.55)}
    .tag.ok .dot{background: rgba(34,197,94,.85)}
    .tag.warn .dot{background: rgba(245,158,11,.9)}
    .tag.bad .dot{background: rgba(239,68,68,.85)}
    .tag b{color:var(--text);font-weight:900}
    .videoWrap{
      position:relative;border-radius: 18px;overflow:hidden;
      border:1px solid var(--line); background:#000;
    }
    video{width:100%;height:auto;display:block}
    .overlay{
      pointer-events:none;position:absolute;inset:0;
      background:
        radial-gradient(closest-side at 50% 50%, transparent 0 62%, rgba(0,0,0,.55) 70% 100%),
        linear-gradient(180deg, rgba(0,0,0,.15), transparent 20%, transparent 80%, rgba(0,0,0,.25));
    }
    .frame{
      position:absolute; left:50%; top:50%;
      width: 78%; height: 42%;
      transform: translate(-50%,-50%);
      border-radius: 18px;
      border: 2px solid rgba(99,179,255,.45);
    }
    .frame:after{
      content:""; position:absolute; left:10%; right:10%; top:50%;
      height:1px; background: rgba(99,179,255,.25);
    }
    .last{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px; margin-top:10px;
    }
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:74px; padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .badge.ok{border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10)}
    .badge.warn{border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.10)}
    .badge.bad{border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10)}
    .mono{font-family:var(--mono)}
    .raw{
      margin-top:8px;font-family:var(--mono);font-size:12px;
      white-space:pre-wrap;word-break:break-all;color: rgba(233,238,247,.92);
    }
    .kv{
      display:grid; grid-template-columns: 140px 1fr;
      gap:10px 12px; margin-top:10px; padding-top:12px;
      border-top:1px dashed rgba(255,255,255,.12);
    }
    .k{color:var(--muted);font-size:12px}
    .v{font-size:13px}
    .dangerText{color: rgba(239,68,68,.92)}
    .okText{color: rgba(34,197,94,.92)}
    .note{
      padding:10px 12px;border-radius: 14px;
      border:1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      margin-top:10px;
    }
    .table{
      width:100%; border-collapse: collapse;
      margin-top:10px; border:1px solid var(--line);
      border-radius: 14px; overflow:hidden; display:block;
    }
    .table thead{display:block;background: rgba(255,255,255,.04);border-bottom:1px solid var(--line)}
    .table tbody{display:block;max-height: 300px; overflow:auto}
    .table tr{display:grid; grid-template-columns: 128px 1fr 120px; gap:10px; align-items:center}
    .table th, .table td{padding:10px 12px; font-size:12px}
    .table th{color:var(--muted); text-align:left; font-weight:900}
    .table td{border-top:1px solid rgba(255,255,255,.06)}
    .table .small{color:var(--muted)}
    .toast{
      position:fixed; left:50%; bottom:18px;
      transform: translateX(-50%);
      min-width: 260px; max-width: 92vw;
      padding:12px 14px;border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(15,26,45,.88);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none; z-index:9999;
    }
    .toast.show{display:block; animation: pop .16s ease-out}
    @keyframes pop{from{opacity:0; transform: translateX(-50%) translateY(6px)} to{opacity:1; transform: translateX(-50%) translateY(0)}}
    .toast .t1{font-weight:950;font-size:13px}
    .toast .t2{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>LinQ VAL PoC Scanner</h1>
          <div class="sub">GS1-128ï¼ˆCODE128ï¼‰å„ªå…ˆ / JAN-13ï¼ˆEAN13ï¼‰ä»£æ›¿ãƒ»åˆ†å‰²è¾æ›¸ï¼ˆ4æ¡ï¼‰ç…§åˆ</div>
        </div>
      </div>
      <div class="pill" title="ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã¯ URL æœ«å°¾ã« ?v=æ•°å­— ã‚’ä»˜ã‘ã¦ãã ã•ã„">
        BUILD <b id="buildLabel">v0</b>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <div class="hd">
          <h2>ã‚¹ã‚­ãƒ£ãƒ³</h2>
          <div class="row">
            <span class="tag" id="zxingTag"><span class="dot"></span><b>ZXing</b> <span id="zxingText">æœªãƒ­ãƒ¼ãƒ‰</span></span>
            <span class="tag" id="camTag"><span class="dot"></span><b>Camera</b> <span id="camText">åœæ­¢ä¸­</span></span>
            <span class="tag" id="dictTag"><span class="dot"></span><b>Dict</b> <span id="dictText">æœªç¢ºèª</span></span>
          </div>
        </div>

        <div class="bd">
          <div class="hint">
            ã€ŒæœŸé™ãƒ»ãƒ­ãƒƒãƒˆãŒèª­ã‚ã‚‹ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆGS1-128ï¼‰ãŒã‚ã‚Œã°å„ªå…ˆã€‚ãªã‘ã‚Œã°JANã§ã‚‚OKã€<br>
            ã‚³ãƒ„ï¼šæ ã„ã£ã±ã„ã«å¯„ã›ã‚‹ï¼æ˜ã‚‹ãï¼2ç§’é™æ­¢ã€‚GS1-128ã¯ç´°ã„ã®ã§è§£åƒåº¦ãŒé‡è¦ã§ã™ã€‚
          </div>

          <div style="margin-top:12px" class="row">
            <button class="btn primary" id="btnStart">â–¶ï¸ Start</button>
            <button class="btn" id="btnStop">â–  Stop</button>
            <button class="btn" id="btnTorch">ğŸ”¦ Light</button>

            <select class="select" id="selMode" title="PoCã¯çµã£ãŸã»ã†ãŒæˆåŠŸç‡ãŒä¸ŠãŒã‚Šã‚„ã™ã„ã§ã™">
              <option value="strict">æ¨å¥¨ï¼šCODE128 + EAN13</option>
              <option value="all">äº’æ›ï¼šMultiFormatï¼ˆå…¨éƒ¨ï¼‰</option>
            </select>

            <select class="select" id="selCamera" title="ã‚«ãƒ¡ãƒ©ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã«é¸ã¹ã¾ã™">
              <option value="">ã‚«ãƒ¡ãƒ©è‡ªå‹•é¸æŠï¼ˆèƒŒé¢å„ªå…ˆï¼‰</option>
            </select>
          </div>

          <div style="margin-top:12px" class="videoWrap">
            <video id="video" playsinline muted></video>
            <div class="overlay"></div>
            <div class="frame"></div>
          </div>

          <div class="note">
            <div class="hint">
              è¾æ›¸ã¯ <b>out4ï¼ˆ4æ¡åˆ†å‰²ï¼‰</b> ã‚’æƒ³å®šï¼š<span class="mono">dict_jan/490/4901.csv</span> ã®ã‚ˆã†ãªæ§‹é€ ã€‚<br>
              ã¾ãšã¯ Pages ä¸Šã§ <span class="mono">dict_jan/490/4901.csv</span> ãŒ 404 ã«ãªã‚‰ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã¨æ—©ã„ã§ã™ã€‚
            </div>
          </div>

          <div class="last">
            <div class="row" style="justify-content:space-between">
              <div style="font-weight:950">Last Scan</div>
              <span class="badge" id="lastBadge">â€”</span>
            </div>
            <div class="raw" id="lastRaw">ã¾ã ã‚¹ã‚­ãƒ£ãƒ³ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>

            <div class="kv">
              <div class="k">GTIN-14</div><div class="v mono" id="vGtin">â€”</div>
              <div class="k">JAN-13</div><div class="v mono" id="vJan">â€”</div>
              <div class="k">ãƒ­ãƒƒãƒˆ(AI10)</div><div class="v mono" id="vLot">â€”</div>
              <div class="k">æœŸé™(AI17)</div><div class="v mono" id="vExp">â€”</div>
              <div class="k">ã‚·ãƒªã‚¢ãƒ«(AI21)</div><div class="v mono" id="vSer">â€”</div>
            </div>

            <div class="kv" style="margin-top:12px">
              <div class="k">è£½å“å</div><div class="v" id="vName">â€”</div>
              <div class="k">ãƒ¡ãƒ¼ã‚«ãƒ¼</div><div class="v" id="vMaker">â€”</div>
              <div class="k">åŒ»äº‹ã‚³ãƒ¼ãƒ‰</div><div class="v mono" id="vIji">â€”</div>
              <div class="k">æ©Ÿèƒ½åŒºåˆ†</div><div class="v mono" id="vKinou">â€”</div>
              <div class="k">ç‰¹å®šå</div><div class="v" id="vTokutei">â€”</div>
              <div class="k">å„Ÿé‚„ä¾¡æ ¼</div><div class="v mono" id="vPrice">â€”</div>
              <div class="k">å…¥æ•°</div><div class="v mono" id="vPack">â€”</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="hd">
          <h2>ãƒ­ã‚° & CSV</h2>
          <div class="row">
            <button class="btn ok small" id="btnExport">â¬‡ï¸ CSV Export</button>
            <button class="btn danger small" id="btnClear">ğŸ—‘ Clear</button>
          </div>
        </div>

        <div class="bd">
          <div class="hint">
            äºŒé‡ç™»éŒ²é˜²æ­¢ï¼šåŒä¸€rawã‚’<b>1ç§’</b>ç„¡è¦–ã€‚<br>
            CSVåˆ—ï¼štimestamp, raw, format, gtin14, jan13keta, lot, exp_ymd, serial, product_name, manufacturer_name, iji_code, kinou_kubun_code, tokutei_name, reimbursement_price_yen, pack_qty
          </div>

          <table class="table">
            <thead>
              <tr><th>æ™‚åˆ»</th><th>å†…å®¹</th><th>çŠ¶æ…‹</th></tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="t1" id="toastT1">OK</div>
    <div class="t2" id="toastT2">â€”</div>
  </div>

<script>
  // =========================
  // BUILD
  // =========================
  const BUILD = "v2026-01-19-02";
  document.getElementById("buildLabel").textContent = BUILD;

  // =========================
  // DOM
  // =========================
  const $ = (id) => document.getElementById(id);
  const els = {
    zxingTag: $("zxingTag"), zxingText: $("zxingText"),
    camTag: $("camTag"), camText: $("camText"),
    dictTag: $("dictTag"), dictText: $("dictText"),
    video: $("video"),
    selMode: $("selMode"),
    selCamera: $("selCamera"),
    lastBadge: $("lastBadge"),
    lastRaw: $("lastRaw"),
    vGtin: $("vGtin"), vJan: $("vJan"), vLot: $("vLot"), vExp: $("vExp"), vSer: $("vSer"),
    vName: $("vName"), vMaker: $("vMaker"), vIji: $("vIji"), vKinou: $("vKinou"),
    vTokutei: $("vTokutei"), vPrice: $("vPrice"), vPack: $("vPack"),
    logBody: $("logBody"),
  };

  function setTag(el, state, text){
    el.classList.remove("ok","warn","bad");
    if (state) el.classList.add(state);
    el.querySelector("span:last-child").textContent = text;
  }
  function setBadge(state, text){
    els.lastBadge.classList.remove("ok","warn","bad");
    if (state) els.lastBadge.classList.add(state);
    els.lastBadge.textContent = text;
  }
  function toast(title, msg, kind="ok"){
    const t = $("toast");
    $("toastT1").textContent = title;
    $("toastT2").textContent = msg;
    t.classList.add("show");
    t.style.borderColor =
      kind === "ok" ? "rgba(34,197,94,.25)" :
      kind === "warn" ? "rgba(245,158,11,.30)" :
      "rgba(239,68,68,.30)";
    setTimeout(()=>t.classList.remove("show"), 1400);
  }
  function haptic(){
    try{ if (navigator.vibrate) navigator.vibrate(40); }catch(e){}
  }
  function nowISO(){ return new Date().toISOString(); }

  function ymdFromAI17(yyMMdd){
    if (!yyMMdd || yyMMdd.length !== 6) return "";
    const yy = yyMMdd.slice(0,2), mm = yyMMdd.slice(2,4), dd = yyMMdd.slice(4,6);
    return `20${yy}-${mm}-${dd}`;
  }
  function isExpired(ymd){
    if (!ymd) return false;
    const d = new Date(ymd + "T00:00:00");
    const t = new Date(); t.setHours(0,0,0,0);
    return d < t;
  }

  // =========================
  // Storage
  // =========================
  const LS_KEY = "linq_val_scans_v2";
  function loadScans(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch(e){ return []; }
  }
  function saveScans(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }

  // =========================
  // CSV export
  // =========================
  function escapeCSV(v){
    if (v === null || v === undefined) return "";
    const s = String(v);
    if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }
  function toCSV(rows, header){
    const lines = [];
    lines.push(header.map(escapeCSV).join(","));
    for (const r of rows) lines.push(header.map(h => escapeCSV(r[h] ?? "")).join(","));
    return lines.join("\n");
  }
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // =========================
  // ZXing loader (robust)
  // =========================
  async function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = src; s.async = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Failed: " + src));
      document.head.appendChild(s);
    });
  }
  async function ensureZXing(){
    if (window.ZXing?.BrowserMultiFormatReader) return true;
    const bust = "v=" + encodeURIComponent(BUILD) + "&t=" + Date.now();
    const urls = [
      "https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js?" + bust,
      "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js?" + bust
    ];
    for (const u of urls){
      try{
        await loadScript(u);
        if (window.ZXing?.BrowserMultiFormatReader) return true;
      }catch(e){}
    }
    return false;
  }

  // =========================
  // GS1 parser (AI 01/10/17/21)
  // =========================
  function parseGS1(raw){
    let s = (raw ?? "").trim();
    if (s.startsWith("]C1")) s = s.slice(3);
    const GS = String.fromCharCode(29);

    const out = { gtin14:"", lot:"", exp_yyMMdd:"", serial:"" };

    function readVar(start, maxLen){
      const endGS = s.indexOf(GS, start);
      const end = (endGS !== -1) ? Math.min(endGS, start+maxLen) : Math.min(s.length, start+maxLen);
      return s.slice(start, end);
    }

    let i = 0;
    while (i < s.length){
      if (s[i] === GS) { i++; continue; }
      const ai2 = s.slice(i, i+2);
      if (ai2 === "01"){
        const val = s.slice(i+2, i+16);
        if (/^\d{14}$/.test(val)) out.gtin14 = val;
        i += 16; continue;
      }
      if (ai2 === "17"){
        const val = s.slice(i+2, i+8);
        if (/^\d{6}$/.test(val)) out.exp_yyMMdd = val;
        i += 8; continue;
      }
      if (ai2 === "10"){
        const val = readVar(i+2, 20);
        out.lot = val;
        i += 2 + val.length;
        if (s[i] === GS) i++;
        continue;
      }
      if (ai2 === "21"){
        const val = readVar(i+2, 20);
        out.serial = val;
        i += 2 + val.length;
        if (s[i] === GS) i++;
        continue;
      }
      i++;
    }
    return out;
  }

  // =========================
  // Dict lookup (out4 split)
  // =========================
  const cache = new Map(); // url -> array of objects

  async function fetchText(url){
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }

  function parseCSV(text){
    // simple CSV parser with quotes
    const rows = [];
    let i=0, field="", row=[], inQ=false;
    while (i < text.length){
      const c = text[i];
      if (inQ){
        if (c === '"'){
          if (text[i+1] === '"'){ field += '"'; i+=2; continue; }
          inQ=false; i++; continue;
        }
        field += c; i++; continue;
      }else{
        if (c === '"'){ inQ=true; i++; continue; }
        if (c === ","){ row.push(field); field=""; i++; continue; }
        if (c === "\n"){
          row.push(field); field="";
          if (row.length > 1 || (row.length === 1 && row[0] !== "")) rows.push(row);
          row=[]; i++; continue;
        }
        if (c === "\r"){ i++; continue; }
        field += c; i++; continue;
      }
    }
    row.push(field);
    if (row.length > 1 || (row.length === 1 && row[0] !== "")) rows.push(row);
    return rows;
  }

  function toObjects(rows){
    if (!rows.length) return [];
    const header = rows[0].map(h => (h ?? "").trim());
    const objs = [];
    for (let r=1; r<rows.length; r++){
      const arr = rows[r];
      const o = {};
      for (let c=0; c<header.length; c++) o[header[c]] = (arr[c] ?? "").trim();
      objs.push(o);
    }
    return objs;
  }

  async function loadObjects(url){
    if (cache.has(url)) return cache.get(url);
    const t = await fetchText(url);
    const objs = toObjects(parseCSV(t));
    cache.set(url, objs);
    return objs;
  }

  function digits(s){ return (s ?? "").toString().replace(/\D/g,""); }
  function jan3jan4(j){ j = digits(j); return j.length>=4 ? {jan3:j.slice(0,3), jan4:j.slice(0,4)} : {jan3:"",jan4:""}; }
  function gt3gt4(g){ g = digits(g); return g.length>=4 ? {gt3:g.slice(0,3), gt4:g.slice(0,4)} : {gt3:"",gt4:""}; }

  async function dictLookup({gtin14, jan13keta}){
    let jan = digits(jan13keta || "");
    const gt = digits(gtin14 || "");

    // If no JAN but GTIN exists â†’ use gtin_index to get jan4
    if (!jan && gt){
      const {gt3, gt4} = gt3gt4(gt);
      if (gt3){
        // out4 expects gtin_index/<gt3>/<gt4>.csv
        const idxUrl = `gtin_index/${gt3}/${gt4}.csv`;
        const idx = await loadObjects(idxUrl);
        const hit = idx.find(r => digits(r.gtin14) === gt);
        if (hit){
          jan = digits(hit.jan13keta ?? hit.jan13 ?? "");
        }
      }
    }

    if (!jan) return null;
    const {jan3, jan4} = jan3jan4(jan);
    if (!jan4) return null;

    const dictUrl = `dict_jan/${jan3}/${jan4}.csv`;
    const dictRows = await loadObjects(dictUrl);

    // In our dict, JAN column is jan13keta
    const hit = dictRows.find(r => digits(r.jan13keta ?? r.jan13 ?? "") === jan)
             || (gt ? dictRows.find(r => digits(r.gtin14) === gt) : null);

    return hit || null;
  }

  // =========================
  // Camera + scanning
  // =========================
  let stream = null;
  let reader = null;
  let torchOn = false;
  let lastRaw = "";
  let lastAt = 0;

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === "videoinput");
      const cur = els.selCamera.value;
      els.selCamera.innerHTML = `<option value="">ã‚«ãƒ¡ãƒ©è‡ªå‹•é¸æŠï¼ˆèƒŒé¢å„ªå…ˆï¼‰</option>`;
      for (const c of cams){
        const opt = document.createElement("option");
        opt.value = c.deviceId;
        opt.textContent = c.label || `Camera ${c.deviceId.slice(0,6)}`;
        els.selCamera.appendChild(opt);
      }
      if (cur) els.selCamera.value = cur;
    }catch(e){}
  }

  async function startCamera(){
    const deviceId = els.selCamera.value;
    const constraints = {
      audio:false,
      video:{
        facingMode: deviceId ? undefined : {ideal:"environment"},
        deviceId: deviceId ? {exact: deviceId} : undefined,
        width:{ideal:1920}, height:{ideal:1080}
      }
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    els.video.srcObject = stream;
    await els.video.play();
    await listCameras();
    setTag(els.camTag, "ok", "ç¨¼åƒä¸­");
    torchOn = false;
  }

  async function stopAll(){
    try{ if (reader) { try{ reader.reset(); }catch(e){} reader=null; } }catch(e){}
    try{
      if (els.video){ els.video.pause(); els.video.srcObject=null; }
      if (stream){ for (const t of stream.getTracks()) t.stop(); stream=null; }
    }catch(e){}
    setTag(els.camTag, "", "åœæ­¢ä¸­");
    torchOn = false;
  }

  async function setTorch(on){
    if (!stream){ toast("Light","ã‚«ãƒ¡ãƒ©é–‹å§‹å¾Œã«åˆ©ç”¨ã§ãã¾ã™","warn"); return; }
    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities?.();
    if (!caps?.torch){ toast("Light","ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ©ã‚¤ãƒˆéå¯¾å¿œ","warn"); return; }
    try{
      await track.applyConstraints({advanced:[{torch:!!on}]});
      torchOn = !!on;
      toast("Light", torchOn ? "ON" : "OFF", "ok");
    }catch(e){
      toast("Light","ãƒ©ã‚¤ãƒˆåˆ‡æ›¿ã«å¤±æ•—","bad");
    }
  }

  function buildReader(){
    const ZX = window.ZXing;
    if (!ZX) throw new Error("ZXing not loaded");
    const mode = els.selMode.value;

    if (mode === "strict"){
      const hints = new Map();
      hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS, [
        ZX.BarcodeFormat.CODE_128,
        ZX.BarcodeFormat.EAN_13
      ]);
      hints.set(ZX.DecodeHintType.TRY_HARDER, true);
      return new ZX.BrowserMultiFormatReader(hints, 250);
    }
    return new ZX.BrowserMultiFormatReader(undefined, 250);
  }

  async function onDecoded(raw, fmt){
    const t = Date.now();
    if (raw === lastRaw && (t - lastAt) < 1000) return; // debounce
    lastRaw = raw; lastAt = t;

    els.lastRaw.textContent = raw || "â€”";

    // clear visible fields
    for (const id of ["vGtin","vJan","vLot","vExp","vSer","vName","vMaker","vIji","vKinou","vTokutei","vPrice","vPack"]){
      els[id].textContent = "â€”";
      els[id].className = els[id].className.replace("dangerText","").replace("okText","");
    }

    const fmtName = (typeof fmt === "number" && window.ZXing)
      ? (Object.keys(window.ZXing.BarcodeFormat).find(k => window.ZXing.BarcodeFormat[k] === fmt) || String(fmt))
      : String(fmt || "");

    let gtin14 = "";
    let jan13keta = "";
    let lot = "";
    let exp_ymd = "";
    let serial = "";

    const d = digits(raw || "");

    if (fmtName.includes("CODE_128")){
      const p = parseGS1(raw);
      gtin14 = digits(p.gtin14);
      lot = p.lot || "";
      serial = p.serial || "";
      exp_ymd = ymdFromAI17(p.exp_yyMMdd || "");
    } else {
      if (d.length === 13) jan13keta = d;
      // heuristic: GS1 payload but format unknown
      if (!jan13keta && (raw || "").includes("01")){
        const p = parseGS1(raw);
        if (p.gtin14) gtin14 = digits(p.gtin14);
        lot = p.lot || lot;
        serial = p.serial || serial;
        exp_ymd = ymdFromAI17(p.exp_yyMMdd || "");
      }
    }

    els.vGtin.textContent = gtin14 || "â€”";
    els.vJan.textContent = jan13keta || "â€”";
    els.vLot.textContent = lot || "â€”";
    els.vSer.textContent = serial || "â€”";

    if (exp_ymd){
      const expired = isExpired(exp_ymd);
      els.vExp.innerHTML = expired
        ? `<span class="dangerText mono">${exp_ymd}ï¼ˆæœŸé™åˆ‡ã‚Œï¼‰</span>`
        : `<span class="okText mono">${exp_ymd}</span>`;
    } else {
      els.vExp.textContent = "â€”";
    }

    // If neither gtin nor jan â†’ error
    if (!gtin14 && !jan13keta){
      setBadge("bad","NG");
      toast("èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼","ã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ï¼ˆè·é›¢/ãƒ–ãƒ¬/ç…§æ˜ï¼‰","bad");
      return;
    }

    // dict lookup
    let dict = null;
    try{
      dict = await dictLookup({gtin14, jan13keta});
      setTag(els.dictTag, "ok", "OK");
    }catch(e){
      // Often path/404
      setTag(els.dictTag, "warn", "æœªé…ç½®/404?");
      dict = null;
    }

    let status = "ok";
    if (!dict) status = "warn";

    if (dict){
      const dj = digits(dict.jan13keta ?? dict.jan13 ?? "");
      if (!jan13keta && dj) jan13keta = dj;
      const dg = digits(dict.gtin14 ?? "");
      if (!gtin14 && dg) gtin14 = dg;

      els.vJan.textContent = jan13keta || els.vJan.textContent;
      els.vGtin.textContent = gtin14 || els.vGtin.textContent;

      els.vName.textContent = dict.product_name || "â€”";
      els.vMaker.textContent = dict.manufacturer_name || "â€”";
      els.vIji.textContent = dict.iji_code || "â€”";
      els.vKinou.textContent = dict.kinou_kubun_code || "â€”";
      els.vTokutei.textContent = dict.tokutei_name || "â€”";
      els.vPrice.textContent = dict.reimbursement_price_yen || "â€”";
      els.vPack.textContent = dict.pack_qty || "â€”";
    } else {
      els.vName.textContent = "ï¼ˆè¾æ›¸æœªãƒ’ãƒƒãƒˆï¼‰";
    }

    if (status === "ok"){
      setBadge("ok","OK");
      toast("ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ", dict?.product_name ? dict.product_name : (gtin14 || jan13keta), "ok");
      haptic();
    } else {
      setBadge("warn","WARN");
      toast("ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸï¼ˆè¾æ›¸ãªã—ï¼‰", gtin14 || jan13keta, "warn");
      haptic();
    }

    // save
    const scans = loadScans();
    scans.push({
      timestamp: nowISO(),
      raw,
      format: fmtName,
      gtin14,
      jan13keta,
      lot,
      exp_ymd,
      serial,
      product_name: dict?.product_name || "",
      manufacturer_name: dict?.manufacturer_name || "",
      iji_code: dict?.iji_code || "",
      kinou_kubun_code: dict?.kinou_kubun_code || "",
      tokutei_name: dict?.tokutei_name || "",
      reimbursement_price_yen: dict?.reimbursement_price_yen || "",
      pack_qty: dict?.pack_qty || "",
      status
    });
    saveScans(scans);
    renderLog();
  }

  async function startScan(){
    const ok = await ensureZXing();
    if (!ok){
      setTag(els.zxingTag, "bad", "èª­è¾¼å¤±æ•—");
      toast("ZXing","ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼ˆCDN/é€šä¿¡ï¼‰","bad");
      return;
    }
    setTag(els.zxingTag, "ok", "Ready");

    await startCamera();
    reader = buildReader();

    // Use continuous decode from video element
    const ZX = window.ZXing;
    try{
      reader.decodeFromVideoElementContinuously(els.video, (result, err)=>{
        if (result){
          const text = result.getText ? result.getText() : String(result.text || result);
          const fmt = result.getBarcodeFormat ? result.getBarcodeFormat() : (result.format || "");
          onDecoded(text, fmt);
        } else if (err && !(err instanceof ZX.NotFoundException)){
          // ignore noisy errors
        }
      });
    }catch(e){
      // fallback
      reader.decodeFromVideoElement(els.video, (result)=>{
        if (result){
          const text = result.getText ? result.getText() : String(result.text || result);
          const fmt = result.getBarcodeFormat ? result.getBarcodeFormat() : (result.format || "");
          onDecoded(text, fmt);
        }
      });
    }
  }

  // =========================
  // Log render
  // =========================
  function renderLog(){
    const scans = loadScans();
    els.logBody.innerHTML = "";
    const recent = scans.slice().reverse().slice(0, 200);
    for (const s of recent){
      const tr = document.createElement("tr");
      const cls = s.status === "ok" ? "ok" : (s.status === "warn" ? "warn" : "bad");
      const txt = s.status === "ok" ? "OK" : (s.status === "warn" ? "WARN" : "NG");
      tr.innerHTML = `
        <td class="mono">${(s.timestamp||"").replace("T"," ").replace("Z","")}</td>
        <td>
          <div class="mono">${(s.gtin14 || s.jan13keta || "â€”")}</div>
          <div class="small mono" style="opacity:.9">${(s.raw||"").slice(0,72)}${(s.raw||"").length>72?"â€¦":""}</div>
        </td>
        <td><span class="badge ${cls}">${txt}</span></td>
      `;
      els.logBody.appendChild(tr);
    }
  }

  // =========================
  // Dict quick check (optional)
  // =========================
  async function dictSmokeTest(){
    // We try to fetch a likely-existing file (490/4900 may or may not exist).
    // Instead, we just check that directories are reachable by trying a known url that should exist in your dataset:
    // If it 404s, show warn. If it returns, show ok.
    // You can change this to match your typical JAN prefix.
    const url = "dict_jan/490/4900.csv";
    try{
      await fetchText(url);
      setTag(els.dictTag, "ok", "é…ç½®OK");
    }catch(e){
      setTag(els.dictTag, "warn", "æœªé…ç½®/404?");
    }
  }

  // =========================
  // Buttons
  // =========================
  $("btnStart").addEventListener("click", async ()=>{
    try{
      toast("Start","ã‚«ãƒ¡ãƒ©èµ·å‹•â€¦","ok");
      await startScan();
    }catch(e){
      setTag(els.camTag, "bad", "å¤±æ•—");
      toast("Startå¤±æ•—", String(e.message || e), "bad");
    }
  });

  $("btnStop").addEventListener("click", async ()=>{
    await stopAll();
    toast("Stop","åœæ­¢ã—ã¾ã—ãŸ","ok");
  });

  $("btnTorch").addEventListener("click", async ()=>{
    await setTorch(!torchOn);
  });

  $("btnExport").addEventListener("click", ()=>{
    const scans = loadScans();
    const header = [
      "timestamp","raw","format","gtin14","jan13keta","lot","exp_ymd","serial",
      "product_name","manufacturer_name","iji_code","kinou_kubun_code","tokutei_name",
      "reimbursement_price_yen","pack_qty"
    ];
    const csv = toCSV(scans, header);
    const fname = `linq_val_poc_scans_${new Date().toISOString().slice(0,10)}.csv`;
    downloadText(fname, csv);
    toast("CSV Export", `${scans.length}ä»¶ã‚’å‡ºåŠ›`, "ok");
  });

  $("btnClear").addEventListener("click", ()=>{
    if (!confirm("ä¿å­˜æ¸ˆã¿ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆç«¯æœ«å†…ï¼‰")) return;
    localStorage.removeItem(LS_KEY);
    renderLog();
    toast("Clear","ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ","ok");
  });

  els.selCamera.addEventListener("change", async ()=>{
    if (!stream) return;
    await stopAll();
    await startScan();
  });

  els.selMode.addEventListener("change", async ()=>{
    if (!stream) return;
    await stopAll();
    await startScan();
  });

  // =========================
  // Init
  // =========================
  (async function init(){
    renderLog();
    setTag(els.camTag, "", "åœæ­¢ä¸­");
    setTag(els.zxingTag, "warn", "æœªãƒ­ãƒ¼ãƒ‰");
    setTag(els.dictTag, "warn", "æœªç¢ºèª");
    await listCameras();
    const ok = await ensureZXing();
    setTag(els.zxingTag, ok ? "ok" : "warn", ok ? "Ready" : "æœªãƒ­ãƒ¼ãƒ‰");
    await dictSmokeTest();
  })();
</script>
</body>
</html>
