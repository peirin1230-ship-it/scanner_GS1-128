<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>LinQ VAL PoC</title>
  <link rel="stylesheet" href="./styles.css?v=20260123-v25" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__title">LinQ VAL PoC</div>
      <div class="brand__sub">barcode × dict × 実施 → 承認 → 医事</div>
    </div>
    <div class="topbar__right">
      <button class="btn btn--ghost" id="btnReset">リセット</button>
    </div>
  </header>

  <!-- Role -->
  <section class="panel" id="viewRole">
    <h2>職種を選択</h2>
    <div class="roleGrid">
      <button class="roleBtn" data-role="field">
        <div class="roleBtn__title">実施入力</div>
        <div class="roleBtn__desc">入力 → スキャン → 確定 → 承認依頼</div>
      </button>
      <button class="roleBtn" data-role="doctor">
        <div class="roleBtn__title">医師</div>
        <div class="roleBtn__desc">承認待ち → コメント → 承認</div>
      </button>
      <button class="roleBtn" data-role="billing">
        <div class="roleBtn__title">医事</div>
        <div class="roleBtn__desc">点検 → 閲覧 → 最終承認</div>
      </button>
    </div>
  </section>

  <!-- Field -->
  <section class="panel hidden" id="viewField">
    <div class="panelHead">
      <button class="btn btn--ghost" id="btnBackFromField">← 戻る</button>
      <div class="panelHead__title">実施入力</div>
    </div>

    <!-- compact summary (hidden during scanning) -->
    <div class="summaryBar" id="summaryBar">
      <div class="summaryBar__line" id="summaryLine">未選択</div>
      <button class="btn btn--small" id="btnToggleSheet">材料リスト</button>
    </div>

    <div class="stepper" id="fieldSteps"></div>

    <!-- Scan area -->
    <div class="scannerWrap" id="scannerWrap">
      <!-- Mask + ROI frame -->
      <div class="roiMask" id="roiMask">
        <div class="roiFrame" id="roiFrame"></div>
        <div class="roiHint" id="roiHint">枠の中央にバーコードを1つだけ合わせてください</div>
      </div>
      <!-- Toast (only visible during scanning) -->
      <div class="scanToast" id="scanToast">準備中…</div>
    </div>

    <div class="scanControls" id="scanControls">
      <button class="btn" id="btnScanStart">スキャン開始</button>
      <button class="btn btn--ghost" id="btnScanStop" disabled>停止</button>
      <button class="btn btn--ghost" id="btnFlash" disabled>ライト</button>
    </div>

    <!-- Suggestions (visible in step4/step5 only, hidden during scanning) -->
    <div class="card hidden" id="suggestCard">
      <div class="card__title">⭐ おすすめ手技</div>
      <div class="muted">材料から推定。タップで手技を切替。</div>
      <div class="pillRow" id="suggestPills"></div>
      <div class="tiny muted" id="suggestWhy"></div>
    </div>

    <!-- Bottom sheet for materials -->
    <div class="sheet hidden" id="sheet">
      <div class="sheet__handle" id="sheetHandle"></div>
      <div class="sheet__head">
        <div class="sheet__title">材料リスト</div>
        <div class="sheet__actions">
          <button class="btn btn--ghost btn--small" id="btnExportField">CSV出力</button>
          <button class="btn btn--ghost btn--small" id="btnCloseSheet">閉じる</button>
        </div>
      </div>
      <div class="sheet__body">
        <div id="materialsList"></div>
      </div>
    </div>

    <div class="card">
      <div class="card__title">確定・承認</div>
      <div class="row">
        <button class="btn" id="btnSubmitForApproval">承認依頼</button>
        <button class="btn btn--ghost" id="btnSaveDraft">下書き保存</button>
      </div>
      <div class="tiny muted" id="fieldStatusHint"></div>
    </div>
  </section>

  <!-- Doctor -->
  <section class="panel hidden" id="viewDoctor">
    <div class="panelHead">
      <button class="btn btn--ghost" id="btnBackFromDoctor">← 戻る</button>
      <div class="panelHead__title">医師（承認）</div>
    </div>

    <div class="card">
      <div class="card__title">ログイン</div>
      <div class="grid2">
        <label class="label">
          診療科
          <select id="doctorDept"></select>
        </label>
        <label class="label">
          医師
          <select id="doctorId"></select>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="card__title">承認待ち</div>
      <div class="row">
        <button class="btn btn--ghost btn--small" id="btnDoctorRefresh">更新</button>
        <button class="btn btn--small" id="btnApproveSelected">選択を一括承認</button>
      </div>
      <label class="label">
        一括コメント
        <input id="doctorBulkComment" placeholder="（任意）" />
      </label>
      <div id="doctorPendingList" class="list"></div>
    </div>

    <div class="card">
      <div class="card__title">Docs（下書きメモ）</div>
      <textarea id="doctorDocs" rows="5" placeholder="症状詳記 / 返書 / その他（医師ID単位で保存）"></textarea>
      <div class="row">
        <button class="btn btn--ghost btn--small" id="btnSaveDocs">保存</button>
        <span class="tiny muted" id="docsHint"></span>
      </div>
    </div>
  </section>

  <!-- Billing -->
  <section class="panel hidden" id="viewBilling">
    <div class="panelHead">
      <button class="btn btn--ghost" id="btnBackFromBilling">← 戻る</button>
      <div class="panelHead__title">医事（閲覧/点検）</div>
    </div>

    <div class="card">
      <div class="card__title">フィルタ</div>
      <div class="grid2">
        <label class="label">
          承認者
          <select id="billingApproverFilter"></select>
        </label>
        <label class="label">
          期間
          <select id="billingDateFilter">
            <option value="today">今日</option>
            <option value="7d">7日</option>
            <option value="all" selected>全期間</option>
          </select>
        </label>
      </div>
      <div class="row">
        <button class="btn btn--ghost btn--small" id="btnBillingRefresh">更新</button>
        <button class="btn btn--ghost btn--small" id="btnExportBilling">CSV出力</button>
      </div>
    </div>

    <div class="card">
      <div class="card__title">承認待ち</div>
      <div class="row">
        <button class="btn btn--small" id="btnBillingForceApprove">選択を一括承認（最終手段）</button>
      </div>
      <div id="billingPendingList" class="list"></div>
    </div>

    <div class="card">
      <div class="card__title">承認済み</div>
      <div id="billingApprovedList" class="list"></div>
    </div>
  </section>

  <!-- Quagga2 (global Quagga) -->
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

  <!-- App -->
  <script type="module" src="./app.js?v=20260123-v25"></script>
</body>
</html>
