<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>LinQ VAL Scanner</title>
  <style>
    :root{
      --bg:#ffffff;
      --ink:#141316;
      --muted:rgba(20,19,22,.62);
      --line:rgba(20,19,22,.10);

      --accent:#e11d48;
      --accent2:#fb7185;

      --shadow: 0 10px 28px rgba(20,19,22,.10);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(900px 480px at 15% -10%, rgba(225,29,72,.10), transparent 60%),
        radial-gradient(700px 420px at 100% 0%, rgba(251,113,133,.10), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, #fff6f8 100%);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 26px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius: var(--r);
      background: rgba(255,255,255,.88);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .title h1{margin:0;font-size:18px;font-weight:1000;letter-spacing:.2px;line-height:1.1}
    .title .sub{margin-top:3px;font-size:13px;color:var(--muted);line-height:1.2}
    .build{font-size:12px;color:var(--muted);padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;white-space:nowrap}
    .build b{color:var(--ink)}

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background: linear-gradient(90deg, rgba(225,29,72,.08), rgba(255,255,255,0));
    }
    .hd .label{font-size:14px;font-weight:1000;letter-spacing:.2px}
    .bd{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .btn{
      appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);
      padding:14px 14px;border-radius: 14px;cursor:pointer;
      font-size:16px;font-weight:1000;letter-spacing:.2px;
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: rgba(225,29,72,.28);
      box-shadow: 0 10px 18px rgba(225,29,72,.10);
      background: linear-gradient(135deg, rgba(225,29,72,.10), rgba(251,113,133,.06));
    }
    .btn.small{padding:10px 12px;font-size:14px;border-radius:12px;font-weight:950}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--line);border-radius:999px;
      font-size:13px;color:var(--muted);background:#fff;white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background: rgba(20,19,22,.20)}
    .pill.on .dot{ background: var(--accent); }

    .videoWrap{
      position:relative;border-radius: var(--r);overflow:hidden;
      border:1px solid var(--line);background:#000;
    }
    video{width:100%;height:auto;display:block}
    .overlay{
      pointer-events:none;position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.10), transparent 25%, transparent 75%, rgba(0,0,0,.18));
    }

    .popout{
      position:absolute;left:12px; right:12px; bottom:12px;
      border-radius: 18px;
      border:1px solid rgba(225,29,72,.25);
      background: linear-gradient(135deg, rgba(225,29,72,.20), rgba(255,255,255,.85) 60%);
      box-shadow: 0 18px 40px rgba(20,19,22,.22);
      backdrop-filter: blur(6px);
      padding:14px 14px;
      display:none;
    }
    .popout.show{display:block; animation: pop .16s ease-out}
    @keyframes pop{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform: translateY(0)}}
    .popTop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .popStatus{font-size:30px;font-weight:1100;letter-spacing:.2px;line-height:1;color: var(--accent)}
    .popMeta{font-size:13px;color:rgba(20,19,22,.65);line-height:1.2;text-align:right;white-space:nowrap}
    .popName{margin-top:8px;font-size:20px;font-weight:1100;line-height:1.18;color: var(--ink)}
    .popPrice{margin-top:6px;font-size:22px;font-weight:1100;color: var(--accent);letter-spacing:.2px}
    .popSmall{margin-top:8px;font-size:13px;color:rgba(20,19,22,.65);font-family: var(--mono);word-break: break-all}

    .hint{margin-top:10px;font-size:14px;color:var(--muted);line-height:1.35}
    .mono{font-family:var(--mono)}
    .em{
      display:inline-flex;align-items:center;
      padding:2px 8px;border-radius:999px;
      border:1px solid rgba(225,29,72,.22);
      background: rgba(225,29,72,.08);
      font-weight:1000;
    }

    .okBanner{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 14px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(225,29,72,.10), rgba(255,255,255,0) 60%);
    }
    .okLeft{display:flex;align-items:center;gap:12px}
    .badgeDot{width:14px;height:14px;border-radius:999px;background: rgba(20,19,22,.20)}
    .okText{font-size:30px;font-weight:1100;letter-spacing:.2px;line-height:1}
    .okSub{font-size:14px;color:var(--muted);margin-top:2px}
    .rightInfo{font-size:14px;color:var(--muted)}

    .prodName{margin-top:14px;font-size:26px;font-weight:1100;line-height:1.18;letter-spacing:.1px}
    .maker{margin-top:8px;font-size:16px;color:var(--muted);line-height:1.25}
    .price{margin-top:10px;font-size:26px;font-weight:1100;color: var(--accent);letter-spacing:.2px;line-height:1.1}

    .kv{
      margin-top:14px;
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px 12px;
      padding-top:14px;
      border-top:1px solid var(--line);
    }
    .k{font-size:13px;color:var(--muted)}
    .v{font-size:16px}

    details{border-top:1px solid var(--line);margin-top:10px;padding-top:10px}
    summary{cursor:pointer;font-size:14px;color:var(--muted);font-weight:950;outline:none}
    .select{
      border:1px solid var(--line);background:#fff;color:var(--ink);
      padding:10px 12px;border-radius: 12px;font-size:14px;min-width: 220px;outline:none;
    }

    .toast{
      position:fixed;left:50%; bottom:16px;transform: translateX(-50%);
      min-width: 260px;max-width: 92vw;padding:12px 14px;border-radius: 16px;
      border:1px solid rgba(225,29,72,.25);
      background: rgba(255,255,255,.96);
      box-shadow: var(--shadow);
      display:none;z-index:9999;backdrop-filter: blur(6px);
    }
    .toast.show{display:block; animation: toastpop .16s ease-out}
    @keyframes toastpop{from{opacity:0; transform: translateX(-50%) translateY(6px)} to{opacity:1; transform: translateX(-50%) translateY(0)}}
    .toast .t1{font-weight:1100;font-size:15px}
    .toast .t2{font-size:13px;color:var(--muted);margin-top:2px;line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>LinQ VAL Scanner</h1>
        <div class="sub">iPhone Safari対策：自動カメラ再起動はしない（手動再起動ボタン）/ 同一5秒無視</div>
      </div>
      <div class="build">BUILD <b id="buildLabel">v0</b></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <div class="label">スキャン</div>
          <div class="row">
            <div class="pill" id="pillZxing"><span class="dot"></span><span>ZXing</span></div>
            <div class="pill" id="pillCam"><span class="dot"></span><span>Camera</span></div>
            <div class="pill" id="pillDict"><span class="dot"></span><span>Dict</span></div>
          </div>
        </div>

        <div class="bd">
          <div class="row">
            <button class="btn primary" id="btnStart">Start</button>
            <button class="btn" id="btnStop">Stop</button>
            <button class="btn" id="btnTorch">Light</button>
            <button class="btn" id="btnReinit" title="iPhone Safariで初回だけ不調な時に押す（設定変更と同等）">再起動</button>
          </div>

          <div style="margin-top:12px" class="videoWrap">
            <video id="video" playsinline muted></video>
            <div class="overlay"></div>

            <div class="popout" id="popout">
              <div class="popTop">
                <div class="popStatus" id="popStatus">OK</div>
                <div class="popMeta" id="popMeta">—</div>
              </div>
              <div class="popName" id="popName">—</div>
              <div class="popPrice" id="popPrice">—</div>
              <div class="popSmall" id="popSmall">—</div>
            </div>
          </div>

          <div class="hint">
            コツ：バーコードを大きく写す／明るく／手ブレを止める。<span class="em">同一バーコードは5秒間無視</span>
          </div>

          <details>
            <summary>設定</summary>
            <div style="margin-top:10px" class="row">
              <select class="select" id="selMode">
                <option value="strict">推奨：CODE128 + EAN13</option>
                <option value="all">互換：MultiFormat（全部）</option>
              </select>
              <select class="select" id="selCamera">
                <option value="">カメラ自動選択（背面優先）</option>
              </select>
            </div>
          </details>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="label">読み取り結果</div>
          <div class="row">
            <button class="btn small" id="btnExport">CSV</button>
            <button class="btn small" id="btnClear">Clear</button>
          </div>
        </div>

        <div class="bd">
          <div class="okBanner">
            <div class="okLeft">
              <div class="badgeDot" id="dotStatus"></div>
              <div>
                <div class="okText" id="txtStatus">待機</div>
                <div class="okSub" id="txtSub">Startで起動</div>
              </div>
            </div>
            <div class="rightInfo">ログ <span class="mono" id="logCount">0</span> 件</div>
          </div>

          <div class="prodName" id="vName">—</div>
          <div class="price" id="vPriceBig">—</div>
          <div class="maker" id="vMaker">—</div>

          <div class="kv">
            <div class="k">JAN-13</div><div class="v mono" id="vJan">—</div>
            <div class="k">GTIN-14</div><div class="v mono" id="vGtin">—</div>
            <div class="k">期限</div><div class="v mono" id="vExp">—</div>
            <div class="k">ロット</div><div class="v mono" id="vLot">—</div>
            <div class="k">シリアル</div><div class="v mono" id="vSer">—</div>
            <div class="k">医事コード</div><div class="v mono" id="vIji">—</div>
            <div class="k">機能区分</div><div class="v mono" id="vKinou">—</div>
            <div class="k">入数</div><div class="v mono" id="vPack">—</div>
          </div>

          <div class="hint" style="margin-top:12px">
            反映が遅いときは URL末尾に <span class="mono">?v=数字</span> を付けて更新。
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="t1" id="toastT1">OK</div>
    <div class="t2" id="toastT2">—</div>
  </div>

<script>
  const BUILD = "v2026-01-19-07";
  document.getElementById("buildLabel").textContent = BUILD;

  const $ = (id) => document.getElementById(id);
  const el = {
    pillZxing: $("pillZxing"),
    pillCam: $("pillCam"),
    pillDict: $("pillDict"),

    video: $("video"),
    selMode: $("selMode"),
    selCamera: $("selCamera"),

    dotStatus: $("dotStatus"),
    txtStatus: $("txtStatus"),
    txtSub: $("txtSub"),

    vName: $("vName"),
    vPriceBig: $("vPriceBig"),
    vMaker: $("vMaker"),

    vJan: $("vJan"),
    vGtin: $("vGtin"),
    vExp: $("vExp"),
    vLot: $("vLot"),
    vSer: $("vSer"),
    vIji: $("vIji"),
    vKinou: $("vKinou"),
    vPack: $("vPack"),

    logCount: $("logCount"),

    popout: $("popout"),
    popStatus: $("popStatus"),
    popMeta: $("popMeta"),
    popName: $("popName"),
    popPrice: $("popPrice"),
    popSmall: $("popSmall"),

    toast: $("toast"),
    toastT1: $("toastT1"),
    toastT2: $("toastT2"),
  };

  function setPill(pill, on){ pill.classList.toggle("on", !!on); }
  function toast(t1, t2){
    el.toastT1.textContent = t1;
    el.toastT2.textContent = t2;
    el.toast.classList.add("show");
    setTimeout(()=>el.toast.classList.remove("show"), 1600);
  }
  function haptic(){ try{ if (navigator.vibrate) navigator.vibrate(40); }catch(e){} }
  function showPopout({status, name, price, meta, small}){
    el.popStatus.textContent = status;
    el.popMeta.textContent = meta || "";
    el.popName.textContent = name || "—";
    el.popPrice.textContent = price || "—";
    el.popSmall.textContent = small || "";
    el.popout.classList.add("show");
    clearTimeout(showPopout._t);
    showPopout._t = setTimeout(()=>el.popout.classList.remove("show"), 2200);
  }

  function digits(s){ return (s ?? "").toString().replace(/\D/g,""); }
  function nowISO(){ return new Date().toISOString(); }
  function ymdFromAI17(yyMMdd){
    if (!yyMMdd || yyMMdd.length !== 6) return "";
    return `20${yyMMdd.slice(0,2)}-${yyMMdd.slice(2,4)}-${yyMMdd.slice(4,6)}`;
  }
  function isExpired(ymd){
    if (!ymd) return false;
    const d = new Date(ymd + "T00:00:00");
    const t = new Date(); t.setHours(0,0,0,0);
    return d < t;
  }
  function formatYen(v){
    const d = digits(v);
    if (!d) return "";
    const n = Number(d);
    if (!Number.isFinite(n)) return `¥${d}`;
    return "¥" + n.toLocaleString("ja-JP");
  }

  function setStatus(kind, label, sub){
    el.dotStatus.style.background =
      kind === "ok" ? "var(--accent)" :
      kind === "warn" ? "rgba(225,29,72,.45)" :
      "rgba(20,19,22,.20)";
    el.txtStatus.textContent = label;
    el.txtSub.textContent = sub || "";
  }

  function clearResult(){
    el.vName.textContent = "—";
    el.vPriceBig.textContent = "—";
    el.vMaker.textContent = "—";
    el.vJan.textContent = "—";
    el.vGtin.textContent = "—";
    el.vExp.textContent = "—";
    el.vLot.textContent = "—";
    el.vSer.textContent = "—";
    el.vIji.textContent = "—";
    el.vKinou.textContent = "—";
    el.vPack.textContent = "—";
  }

  // ===== local log =====
  const LS_KEY = "linq_val_scans_v7";
  function loadScans(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch(e){ return []; } }
  function saveScans(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
  function updateCount(){ el.logCount.textContent = String(loadScans().length); }

  // ===== CSV export =====
  function escapeCSV(v){
    if (v === null || v === undefined) return "";
    const s = String(v);
    if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }
  function toCSV(rows, header){
    const lines = [];
    lines.push(header.map(escapeCSV).join(","));
    for (const r of rows) lines.push(header.map(h => escapeCSV(r[h] ?? "")).join(","));
    return lines.join("\n");
  }
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // ===== ZXing loader =====
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement("script");
      s.src = src; s.async = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Failed: " + src));
      document.head.appendChild(s);
    });
  }
  async function ensureZXing(){
    if (window.ZXing?.BrowserMultiFormatReader) return true;
    const bust = "v=" + encodeURIComponent(BUILD) + "&t=" + Date.now();
    const urls = [
      "https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js?" + bust,
      "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js?" + bust
    ];
    for (const u of urls){
      try{
        await loadScript(u);
        if (window.ZXing?.BrowserMultiFormatReader) return true;
      }catch(e){}
    }
    return false;
  }

  // ===== GS1 parser =====
  function parseGS1(raw){
    let s = (raw ?? "").trim();
    if (s.startsWith("]C1")) s = s.slice(3);
    const GS = String.fromCharCode(29);
    const out = { gtin14:"", lot:"", exp_yyMMdd:"", serial:"" };
    function readVar(start, maxLen){
      const endGS = s.indexOf(GS, start);
      const end = (endGS !== -1) ? Math.min(endGS, start+maxLen) : Math.min(s.length, start+maxLen);
      return s.slice(start, end);
    }
    let i = 0;
    while (i < s.length){
      if (s[i] === GS) { i++; continue; }
      const ai2 = s.slice(i, i+2);
      if (ai2 === "01"){ const val = s.slice(i+2, i+16); if (/^\d{14}$/.test(val)) out.gtin14 = val; i += 16; continue; }
      if (ai2 === "17"){ const val = s.slice(i+2, i+8); if (/^\d{6}$/.test(val)) out.exp_yyMMdd = val; i += 8; continue; }
      if (ai2 === "10"){ const val = readVar(i+2, 20); out.lot = val; i += 2 + val.length; if (s[i] === GS) i++; continue; }
      if (ai2 === "21"){ const val = readVar(i+2, 20); out.serial = val; i += 2 + val.length; if (s[i] === GS) i++; continue; }
      i++;
    }
    return out;
  }

  // ===== Dict lookup =====
  const cache = new Map();
  async function fetchText(url){
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }
  function parseCSV(text){
    const rows = [];
    let i=0, field="", row=[], inQ=false;
    while (i < text.length){
      const c = text[i];
      if (inQ){
        if (c === '"'){
          if (text[i+1] === '"'){ field += '"'; i+=2; continue; }
          inQ=false; i++; continue;
        }
        field += c; i++; continue;
      }else{
        if (c === '"'){ inQ=true; i++; continue; }
        if (c === ","){ row.push(field); field=""; i++; continue; }
        if (c === "\n"){
          row.push(field); field="";
          if (row.length > 1 || (row.length === 1 && row[0] !== "")) rows.push(row);
          row=[]; i++; continue;
        }
        if (c === "\r"){ i++; continue; }
        field += c; i++; continue;
      }
    }
    row.push(field);
    if (row.length > 1 || (row.length === 1 && row[0] !== "")) rows.push(row);
    return rows;
  }
  function toObjects(rows){
    if (!rows.length) return [];
    const header = rows[0].map(h => (h ?? "").trim());
    const objs = [];
    for (let r=1; r<rows.length; r++){
      const arr = rows[r];
      const o = {};
      for (let c=0; c<header.length; c++) o[header[c]] = (arr[c] ?? "").trim();
      objs.push(o);
    }
    return objs;
  }
  async function loadObjects(url){
    if (cache.has(url)) return cache.get(url);
    const t = await fetchText(url);
    const objs = toObjects(parseCSV(t));
    cache.set(url, objs);
    return objs;
  }
  function jan3jan4(j){ j = digits(j); return j.length>=4 ? {jan3:j.slice(0,3), jan4:j.slice(0,4)} : {jan3:"",jan4:""}; }
  function gt3gt4(g){ g = digits(g); return g.length>=4 ? {gt3:g.slice(0,3), gt4:g.slice(0,4)} : {gt3:"",gt4:""}; }

  async function dictLookup({gtin14, jan13keta}){
    let jan = digits(jan13keta || "");
    const gt = digits(gtin14 || "");
    if (!jan && gt){
      const {gt3, gt4} = gt3gt4(gt);
      if (gt3){
        const idxUrl = `gtin_index/${gt3}/${gt4}.csv`;
        const idxRows = await loadObjects(idxUrl);
        const hit = idxRows.find(r => digits(r.gtin14) === gt);
        if (hit) jan = digits(hit.jan13keta ?? hit.jan13 ?? "");
      }
    }
    if (!jan) return null;
    const {jan3, jan4} = jan3jan4(jan);
    if (!jan4) return null;
    const dictUrl = `dict_jan/${jan3}/${jan4}.csv`;
    const dictRows = await loadObjects(dictUrl);
    return dictRows.find(r => digits(r.jan13keta ?? r.jan13 ?? "") === jan)
        || (gt ? dictRows.find(r => digits(r.gtin14) === gt) : null)
        || null;
  }

  // ===== Camera/scanning =====
  let stream = null;
  let reader = null;
  let torchOn = false;

  const DEDUP_MS = 5000;
  let lastRaw = "";
  let lastAt = 0;

  // safari-ready: count callback ticks even when NotFound
  let ticks = 0;

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === "videoinput");
      const cur = el.selCamera.value;
      el.selCamera.innerHTML = `<option value="">カメラ自動選択（背面優先）</option>`;
      for (const c of cams){
        const opt = document.createElement("option");
        opt.value = c.deviceId;
        opt.textContent = c.label || `Camera ${c.deviceId.slice(0,6)}`;
        el.selCamera.appendChild(opt);
      }
      if (cur) el.selCamera.value = cur;
    }catch(e){}
  }

  async function startCamera(){
    const deviceId = el.selCamera.value;
    const constraints = {
      audio:false,
      video:{
        facingMode: deviceId ? undefined : {ideal:"environment"},
        deviceId: deviceId ? {exact: deviceId} : undefined,
        width:{ideal:1920}, height:{ideal:1080}
      }
    };

    try{
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    }catch(e){
      setPill(el.pillCam, false);
      setStatus("warn","権限エラー","Safariのカメラ許可をONに");
      toast("カメラ権限", "Safariでカメラを許可してください");
      throw e;
    }

    el.video.srcObject = stream;

    try{
      await el.video.play(); // must succeed under user gesture
    }catch(e){
      setStatus("warn","再生できません","Startをもう一度 / 許可確認");
      toast("再生不可", "Safariのカメラ許可を確認");
      throw e;
    }

    setPill(el.pillCam, true);
    torchOn = false;
  }

  async function stopAll(){
    try{ if (reader) { try{ reader.reset(); }catch(e){} reader=null; } }catch(e){}
    try{
      if (el.video){ el.video.pause(); el.video.srcObject=null; }
      if (stream){ for (const t of stream.getTracks()) t.stop(); stream=null; }
    }catch(e){}
    setPill(el.pillCam, false);
    torchOn = false;
    setStatus("idle","停止中","Startで起動");
    el.popout.classList.remove("show");
  }

  async function setTorch(on){
    if (!stream){ toast("Light","カメラ開始後に利用"); return; }
    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities?.();
    if (!caps?.torch){ toast("Light","ライト非対応"); return; }
    try{
      await track.applyConstraints({advanced:[{torch:!!on}]});
      torchOn = !!on;
      toast("Light", torchOn ? "ON" : "OFF");
    }catch(e){
      toast("Light","切替失敗");
    }
  }

  function buildReader(){
    const ZX = window.ZXing;
    const mode = el.selMode.value;
    if (mode === "strict"){
      const hints = new Map();
      hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS, [ZX.BarcodeFormat.CODE_128, ZX.BarcodeFormat.EAN_13]);
      hints.set(ZX.DecodeHintType.TRY_HARDER, true);
      return new ZX.BrowserMultiFormatReader(hints, 250);
    }
    return new ZX.BrowserMultiFormatReader(undefined, 250);
  }

  function startDecodeLoop(){
    const ZX = window.ZXing;
    reader = buildReader();
    ticks = 0;

    reader.decodeFromVideoElementContinuously(el.video, (result, err)=>{
      if (result){
        ticks++; // tick
        const text = result.getText ? result.getText() : String(result.text || result);
        const fmt = result.getBarcodeFormat ? result.getBarcodeFormat() : (result.format || "");
        onDecoded(text, fmt);
      } else if (err){
        // NotFoundException is normal -> still counts as "loop running"
        if (err instanceof ZX.NotFoundException){
          ticks++;
          return;
        }
        // other errors ignore
      }
    });
  }

  async function restartDecoderOnly(){
    try{ if (reader) { try{ reader.reset(); }catch(e){} } }catch(e){}
    reader = null;
    startDecodeLoop();
  }

  async function onDecoded(raw, fmt){
    const t = Date.now();
    if (raw === lastRaw && (t - lastAt) < DEDUP_MS) return;
    lastRaw = raw; lastAt = t;

    clearResult();
    setStatus("warn","照合中…","辞書照合しています");

    const fmtName = (typeof fmt === "number" && window.ZXing)
      ? (Object.keys(window.ZXing.BarcodeFormat).find(k => window.ZXing.BarcodeFormat[k] === fmt) || String(fmt))
      : String(fmt || "");

    let gtin14 = "";
    let jan13keta = "";
    let lot = "";
    let exp_ymd = "";
    let serial = "";

    const d = digits(raw || "");

    if (fmtName.includes("CODE_128")){
      const p = parseGS1(raw);
      gtin14 = digits(p.gtin14);
      lot = p.lot || "";
      serial = p.serial || "";
      exp_ymd = ymdFromAI17(p.exp_yyMMdd || "");
    } else {
      if (d.length === 13) jan13keta = d;
      if (!jan13keta && (raw || "").includes("01")){
        const p = parseGS1(raw);
        if (p.gtin14) gtin14 = digits(p.gtin14);
        lot = p.lot || lot;
        serial = p.serial || serial;
        exp_ymd = ymdFromAI17(p.exp_yyMMdd || "");
      }
    }

    if (!gtin14 && !jan13keta){
      setStatus("warn","未検出","大きく写して静止");
      toast("読み取り失敗","大きく写して静止");
      return;
    }

    el.vJan.textContent = jan13keta || "—";
    el.vGtin.textContent = gtin14 || "—";
    el.vLot.textContent = lot || "—";
    el.vSer.textContent = serial || "—";
    el.vExp.textContent = exp_ymd ? (isExpired(exp_ymd) ? `${exp_ymd}（期限切れ）` : exp_ymd) : "—";

    let dict = null;
    try{
      dict = await dictLookup({gtin14, jan13keta});
      setPill(el.pillDict, true);
    }catch(e){
      setPill(el.pillDict, false);
      dict = null;
    }

    if (dict){
      const dj = digits(dict.jan13keta ?? dict.jan13 ?? "");
      const dg = digits(dict.gtin14 ?? "");
      if (!jan13keta && dj) jan13keta = dj;
      if (!gtin14 && dg) gtin14 = dg;

      el.vJan.textContent = jan13keta || el.vJan.textContent;
      el.vGtin.textContent = gtin14 || el.vGtin.textContent;

      const name = dict.product_name || "—";
      const maker = dict.manufacturer_name || "—";
      const price = formatYen(dict.reimbursement_price_yen || "");

      el.vName.textContent = name;
      el.vMaker.textContent = maker;
      el.vPriceBig.textContent = price ? price : "—";

      el.vIji.textContent = dict.iji_code || "—";
      el.vKinou.textContent = dict.kinou_kubun_code || "—";
      el.vPack.textContent = dict.pack_qty || "—";

      setStatus("ok","OK","辞書一致");
      showPopout({status:"OK", name, price: price || "—", meta:"辞書一致", small:`JAN:${jan13keta}  GTIN:${gtin14}`});
      haptic();
    } else {
      setStatus("warn","WARN","辞書なし");
      showPopout({status:"WARN", name: gtin14 || jan13keta || "—", price:"—", meta:"辞書なし", small:`${gtin14 || ""} ${jan13keta || ""}`.trim()});
      haptic();
    }

    const scans = loadScans();
    scans.push({
      timestamp: nowISO(),
      raw,
      format: fmtName,
      gtin14,
      jan13keta,
      lot,
      exp_ymd,
      serial,
      product_name: dict?.product_name || "",
      manufacturer_name: dict?.manufacturer_name || "",
      iji_code: dict?.iji_code || "",
      kinou_kubun_code: dict?.kinou_kubun_code || "",
      tokutei_name: dict?.tokutei_name || "",
      reimbursement_price_yen: dict?.reimbursement_price_yen || "",
      pack_qty: dict?.pack_qty || "",
      status: dict ? "ok" : "warn"
    });
    saveScans(scans);
    updateCount();
  }

  // ===== UI helpers =====
  function setStatus(kind, label, sub){
    el.dotStatus.style.background =
      kind === "ok" ? "var(--accent)" :
      kind === "warn" ? "rgba(225,29,72,.45)" :
      "rgba(20,19,22,.20)";
    el.txtStatus.textContent = label;
    el.txtSub.textContent = sub || "";
  }

  // ===== Start =====
  async function startScan(){
    setStatus("idle","起動中…","ZXing/カメラ準備");
    const ok = await ensureZXing();
    setPill(el.pillZxing, ok);
    if (!ok){
      setStatus("warn","ZXing失敗","CDN/通信を確認");
      toast("ZXing","CDN/通信を確認");
      return;
    }

    await startCamera();
    setPill(el.pillCam, true);
    setStatus("idle","待機","スキャンしてください");

    // start decoder
    startDecodeLoop();

    // ✅ 初回だけ読めない対策：カメラは触らず、デコーダだけリスタート
    setTimeout(async ()=>{
      if (ticks === 0){
        setStatus("warn","準備中…","（デコーダ再起動）");
        await restartDecoderOnly();
      }
    }, 1200);
  }

  // ===== Buttons =====
  $("btnStart").addEventListener("click", async ()=>{
    try{ await startScan(); }catch(e){ setStatus("warn","Start失敗", "Safariの許可を確認"); }
  });
  $("btnStop").addEventListener("click", async ()=>{ await stopAll(); });
  $("btnTorch").addEventListener("click", async ()=>{ await setTorch(!torchOn); });

  // ✅ 手動再起動：ユーザー操作でカメラ再初期化（設定変更と同等）
  $("btnReinit").addEventListener("click", async ()=>{
    await stopAll();
    await startScan();
    toast("再起動", "カメラ/デコーダを再初期化しました");
  });

  $("btnExport").addEventListener("click", ()=>{
    const scans = loadScans();
    const header = [
      "timestamp","raw","format","gtin14","jan13keta","lot","exp_ymd","serial",
      "product_name","manufacturer_name","iji_code","kinou_kubun_code","tokutei_name",
      "reimbursement_price_yen","pack_qty"
    ];
    downloadText(`linq_val_poc_scans_${new Date().toISOString().slice(0,10)}.csv`, toCSV(scans, header));
    toast("CSV", `${scans.length}件`);
  });

  $("btnClear").addEventListener("click", ()=>{
    if (!confirm("端末内ログを削除しますか？")) return;
    localStorage.removeItem(LS_KEY);
    updateCount();
    toast("Clear","完了");
  });

  el.selCamera.addEventListener("change", async ()=>{
    if (!stream) return;
    await stopAll();
    await startScan();
  });
  el.selMode.addEventListener("change", async ()=>{
    if (!stream) return;
    await stopAll();
    await startScan();
  });

  // ===== Init =====
  (async function init(){
    clearResult();
    updateCount();
    setStatus("idle","待機","Startで起動");
    setPill(el.pillZxing, false);
    setPill(el.pillCam, false);
    setPill(el.pillDict, false);
    await listCameras();
    const ok = await ensureZXing();
    setPill(el.pillZxing, ok);
  })();

  // ===== Missing functions from previous versions =====
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement("script");
      s.src = src; s.async = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error("Failed: " + src));
      document.head.appendChild(s);
    });
  }

  // ===== Permissions sanity note (no code) =====

</script>
</body>
</html>